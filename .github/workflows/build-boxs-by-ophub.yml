name: Build ImmortalWrt for fine3399
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 检出代码
        uses: actions/checkout@v3

      - name: 设置可执行权限
        run: chmod +x ${{ github.workspace }}/n1/build.sh

      - name: 调试工作区内容
        run: ls -R

      - name: 集成 OpenAppFilter 源码
        run: |
          echo "✅ 开始下载 OpenAppFilter 源码"
          mkdir -p ${{ github.workspace }}/package
          git clone https://github.com/destan19/OpenAppFilter.git ${{ github.workspace }}/package/OpenAppFilter
          echo "✅ 已下载 OpenAppFilter 源码"

      - name: 构建 fine3399 固件（含 OpenAppFilter）
        run: |
          echo "✅ 使用 ImageBuilder 构建 fine3399 固件"
          docker run --rm -i \
            --user root \
            -v "${{ github.workspace }}/bin:/home/build/immortalwrt/bin" \
            -v "${{ github.workspace }}/files/etc/uci-defaults:/home/build/immortalwrt/files/etc/uci-defaults" \
            -v "${{ github.workspace }}/arch/arch.conf:/home/build/immortalwrt/files/etc/opkg/arch.conf" \
            -v "${{ github.workspace }}/shell:/home/build/immortalwrt/shell" \
            -v "${{ github.workspace }}/n1/banner:/home/build/immortalwrt/files/mnt/banner" \
            -v "${{ github.workspace }}/n1/imm.config:/home/build/immortalwrt/.config" \
            -v "${{ github.workspace }}/n1/build.sh:/home/build/immortalwrt/build.sh" \
            -v "${{ github.workspace }}/package/OpenAppFilter:/home/build/immortalwrt/package/OpenAppFilter" \
            -e PROFILE="rockchip/fine3399" \
            -e CONFIG_PACKAGE_luci-app-oaf=y \
            -e CONFIG_PACKAGE_open-app-filter=y \
            -e CONFIG_PACKAGE_oaf=y \
            -e CONFIG_PACKAGE_kmod-oaf=y \
            immortalwrt/imagebuilder:armsr-armv8-openwrt-24.10.2 /bin/bash -c "
              cd /home/build/immortalwrt && \
              make image V=s
            "

      - name: 打包为 ophub 的 ImmortalWrt（fine3399）
        uses: ophub/amlogic-s9xxx-openwrt@main
        with:
          openwrt_path: "${{ github.workspace }}/bin/targets/rockchip/armv8/"
          openwrt_board: "fine3399"
          openwrt_kernel: "6.1.y"
          auto_kernel: true
          kernel_repo: "ophub/kernel"
          kernel_usage: flippy
          builder_name: "your_name"  # 替换为你的名称

      - name: 重命名 fine3399 固件文件
        run: |
          MODEL="fine3399"
          KERNEL_VERSION="$(ls ${{ github.workspace }}/bin/targets/rockchip/armv8/ | grep -oP 'k\d+\.\d+\.\d+' | head -n1)"
          if [[ -z "$KERNEL_VERSION" ]]; then
            echo "未找到内核版本信息，使用默认命名"
            KERNEL_VERSION="default"
          fi
          for FILE in ${{ github.workspace }}/bin/targets/rockchip/armv8/*.img.gz; do
            FILENAME=$(basename "$FILE")
            NEW_NAME="immortalwrt-fine3399-btrfs-${KERNEL_VERSION}.img.gz"
            mv "$FILE" "${{ github.workspace }}/bin/targets/rockchip/armv8/$NEW_NAME"
            echo "重命名为: $NEW_NAME"
          done

      - name: 上传 fine3399 固件到 GitHub Releases
        uses: softprops/action-gh-release@v2.2.1
        with:
          tag_name: fine3399-build
          name: ImmortalWrt for fine3399 (含 OpenAppFilter 插件)
          body: |
            ## 构建信息
            - 设备型号：fine3399
            - 内核版本：6.1.y
            - 作者：your_name  # 替换为你的名称
            - 集成组件：OpenAppFilter
          files: "${{ github.workspace }}/bin/targets/rockchip/armv8/*.img.gz"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
